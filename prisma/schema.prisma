generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
}

model User {
    id        String   @id @default(uuid())
    email     String?  @unique
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    bankConnections BankConnection[]
    expenses        Expense[]
    expenseSplits   ExpenseSplit[]
    incomes         Income[]
}

model BankConnection {
    id              String   @id @default(uuid())
    userId          String
    itemId          String   @unique
    accessToken     String
    institutionId   String?
    institutionName String?
    status          String   @default("active")
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    accounts     Account[]
    transactions Transaction[]

    @@index([userId])
}

model Account {
    id               String   @id @default(uuid())
    bankConnectionId String
    accountId        String   @unique
    name             String
    officialName     String?
    type             String
    subtype          String?
    currentBalance   Float?
    availableBalance Float?
    currency         String?
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    bankConnection BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
    transactions   Transaction[]

    @@index([bankConnectionId])
    @@index([accountId])
}

model Transaction {
    id               String   @id @default(uuid())
    bankConnectionId String
    accountId        String
    transactionId    String   @unique
    date             DateTime
    name             String
    amount           Float
    currency         String?
    category         String?
    pending          Boolean  @default(false)
    merchantName     String?
    linkedToExpense  Boolean  @default(false)
    expenseId        String?
    linkedToIncome   Boolean  @default(false)
    incomeId         String?
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    bankConnection BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
    account        Account        @relation(fields: [accountId], references: [accountId], onDelete: Cascade)
    expense        Expense?       @relation(fields: [expenseId], references: [id], onDelete: SetNull)
    income         Income?        @relation(fields: [incomeId], references: [id], onDelete: SetNull)

    @@index([bankConnectionId])
    @@index([accountId])
    @@index([date])
    @@index([expenseId])
    @@index([incomeId])
}

model Category {
    id          String    @id @default(uuid())
    name        String    @unique
    description String?
    color       String?
    icon        String?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    expenses    Expense[]

    @@index([name])
}

model Expense {
    id          String   @id @default(uuid())
    date        DateTime
    description String
    categoryId  String
    amount      Float
    currency    String   @default("EUR")
    paidById    String
    type        String   @default("shared")
    paid        Boolean  @default(false)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    category     Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    paidBy       User           @relation(fields: [paidById], references: [id], onDelete: Cascade)
    splits       ExpenseSplit[]
    transactions Transaction[]

    @@index([date])
    @@index([categoryId])
    @@index([paidById])
    @@index([type])
}

model ExpenseSplit {
    id        String   @id @default(uuid())
    expenseId String
    userId    String
    amount    Float
    paid      Boolean  @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([expenseId, userId])
    @@index([expenseId])
    @@index([userId])
}

model Income {
    id          String   @id @default(uuid())
    userId      String
    date        DateTime
    description String
    amount      Float
    currency    String   @default("EUR")
    type        String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    transactions Transaction[]

    @@index([userId])
    @@index([date])
    @@index([type])
}

model Settings {
    id               String   @id @default(uuid())
    defaultPaidBy    String?
    defaultType      String   @default("shared")
    defaultSplitType String   @default("equal")
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt
}

model UserSplitRatio {
    id        String   @id @default(uuid())
    userId    String   @unique
    ratio     Float    @default(0.5)
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([isActive])
}
