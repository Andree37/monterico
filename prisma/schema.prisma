generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
}

// User = Account owner who logs into the app
model User {
    id               String    @id @default(uuid())
    email            String    @unique
    emailVerified    DateTime?
    password         String
    mfaRequired      Boolean   @default(false)
    mfaSetupComplete Boolean   @default(false)
    accountingMode   String    @default("individual")
    createdAt        DateTime  @default(now())
    updatedAt        DateTime  @updatedAt

    mfaMethods       MFAMethod[]
    bankConnections  BankConnection[]
    householdMembers HouseholdMember[]
    categories       Category[]
    expenses         Expense[]
    incomes          Income[]
    reimbursements   Reimbursement[]
    userSettings     UserSettings?
}

// HouseholdMember = People in the user's household (wife, kids, etc.)
model HouseholdMember {
    id        String   @id @default(uuid())
    userId    String
    name      String
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user            User                            @relation(fields: [userId], references: [id], onDelete: Cascade)
    expenses        Expense[]
    expenseSplits   ExpenseSplit[]
    incomes         Income[]
    reimbursements  Reimbursement[]
    splitRatio      HouseholdMemberSplitRatio?
    allowanceConfig HouseholdMemberAllowanceConfig?

    @@index([userId])
    @@index([isActive])
}

model MFAMethod {
    id        String   @id @default(uuid())
    userId    String
    type      String
    name      String?
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    passkeyData    PasskeyData?
    totpData       TOTPData?
    backupCodeData BackupCodeData?

    @@index([userId])
    @@index([type])
}

model PasskeyData {
    id           String   @id @default(uuid())
    mfaMethodId  String   @unique
    credentialId String   @unique
    publicKey    String
    counter      Int      @default(0)
    transports   String?
    lastUsedAt   DateTime @default(now())

    mfaMethod MFAMethod @relation(fields: [mfaMethodId], references: [id], onDelete: Cascade)

    @@index([credentialId])
}

model TOTPData {
    id          String   @id @default(uuid())
    mfaMethodId String   @unique
    secret      String
    lastUsedAt  DateTime @default(now())

    mfaMethod MFAMethod @relation(fields: [mfaMethodId], references: [id], onDelete: Cascade)
}

model BackupCodeData {
    id          String  @id @default(uuid())
    mfaMethodId String  @unique
    codes       String
    usedCodes   String?

    mfaMethod MFAMethod @relation(fields: [mfaMethodId], references: [id], onDelete: Cascade)
}

model BankConnection {
    id              String   @id @default(uuid())
    userId          String?
    itemId          String   @unique
    accessToken     String
    institutionId   String?
    institutionName String?
    status          String   @default("active")
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
    accounts     BankAccount[]
    transactions Transaction[]

    @@index([userId])
}

model BankAccount {
    id               String   @id @default(uuid())
    bankConnectionId String
    accountId        String   @unique
    name             String
    officialName     String?
    type             String
    subtype          String?
    currentBalance   Float?
    availableBalance Float?
    currency         String?
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    bankConnection BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
    transactions   Transaction[]

    @@index([bankConnectionId])
    @@index([accountId])
}

model Transaction {
    id               String   @id @default(uuid())
    bankConnectionId String
    accountId        String
    transactionId    String
    date             DateTime
    name             String
    amount           Float
    currency         String?
    category         String?
    pending          Boolean  @default(false)
    merchantName     String?
    linkedToExpense  Boolean  @default(false)
    expenseId        String?
    linkedToIncome   Boolean  @default(false)
    incomeId         String?
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    bankConnection BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)
    account        BankAccount    @relation(fields: [accountId], references: [accountId], onDelete: Cascade)
    expense        Expense?       @relation(fields: [expenseId], references: [id], onDelete: SetNull)
    income         Income?        @relation(fields: [incomeId], references: [id], onDelete: SetNull)

    @@unique([transactionId, accountId])
    @@index([bankConnectionId])
    @@index([accountId])
    @@index([date])
    @@index([expenseId])
    @@index([incomeId])
}

model Category {
    id          String   @id @default(uuid())
    userId      String
    name        String
    description String?
    color       String?
    icon        String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    expenses Expense[]

    @@unique([userId, name])
    @@index([userId])
    @@index([name])
}

model Expense {
    id                 String   @id @default(uuid())
    userId             String
    date               DateTime
    description        String
    categoryId         String
    amount             Float
    currency           String   @default("EUR")
    paidById           String
    type               String   @default("shared")
    paid               Boolean  @default(false)
    paidFromPool       Boolean  @default(false)
    needsReimbursement Boolean  @default(false)
    reimbursementId    String?
    createdAt          DateTime @default(now())
    updatedAt          DateTime @updatedAt

    user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    category      Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    paidBy        HouseholdMember @relation(fields: [paidById], references: [id], onDelete: Cascade)
    splits        ExpenseSplit[]
    transactions  Transaction[]
    reimbursement Reimbursement?  @relation(fields: [reimbursementId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@index([date])
    @@index([categoryId])
    @@index([paidById])
    @@index([type])
    @@index([reimbursementId])
}

model ExpenseSplit {
    id                String   @id @default(uuid())
    expenseId         String
    householdMemberId String
    amount            Float
    paid              Boolean  @default(false)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    expense         Expense         @relation(fields: [expenseId], references: [id], onDelete: Cascade)
    householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id], onDelete: Cascade)

    @@unique([expenseId, householdMemberId])
    @@index([expenseId])
    @@index([householdMemberId])
}

model Income {
    id                String   @id @default(uuid())
    userId            String
    householdMemberId String
    date              DateTime
    allocatedToMonth  String?
    description       String
    amount            Float
    currency          String   @default("EUR")
    type              String
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id], onDelete: Cascade)
    transactions    Transaction[]

    @@index([userId])
    @@index([householdMemberId])
    @@index([date])
    @@index([type])
    @@index([allocatedToMonth])
}

model UserSettings {
    id               String   @id @default(uuid())
    userId           String   @unique
    defaultType      String   @default("shared")
    defaultSplitType String   @default("equal")
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

model HouseholdMemberSplitRatio {
    id                String   @id @default(uuid())
    householdMemberId String   @unique
    ratio             Float    @default(0.5)
    isActive          Boolean  @default(true)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id], onDelete: Cascade)

    @@index([householdMemberId])
    @@index([isActive])
}

model HouseholdMemberAllowanceConfig {
    id                String   @id @default(uuid())
    householdMemberId String   @unique
    type              String   @default("percentage")
    value             Float
    isActive          Boolean  @default(true)
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id], onDelete: Cascade)

    @@index([householdMemberId])
    @@index([isActive])
}

model Reimbursement {
    id                String    @id @default(uuid())
    userId            String
    householdMemberId String
    month             String
    amount            Float
    description       String
    settled           Boolean   @default(false)
    settledAt         DateTime?
    createdAt         DateTime  @default(now())
    updatedAt         DateTime  @updatedAt

    user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    householdMember HouseholdMember @relation(fields: [householdMemberId], references: [id], onDelete: Cascade)
    expenses        Expense[]

    @@index([userId])
    @@index([householdMemberId])
    @@index([month])
    @@index([settled])
}
